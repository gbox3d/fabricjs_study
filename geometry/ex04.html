<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title> fabrics geometry </title>
    <script src="../node_modules/fabric/dist/fabric.js"></script>

    <style>
        .hide {
            display: none;
        }
    </style>
</head>

<body>

    <canvas id="main-canvas" width="512" height="512"></canvas>

    <script type="module">

        //https://velog.io/@fivewinds/fabricjs%EC%97%90%EC%84%9C-%EB%91%90-Polygon%EA%B0%9C%EC%B2%B4%EA%B0%80-%EA%B5%90%EC%B0%A8%ED%95%98%EB%8A%94%EC%A7%80-%ED%8C%90%EB%B3%84%ED%95%98%EA%B8%B0

        const fbCanvas = new fabric.Canvas('main-canvas', {
            backgroundColor: '#000',
            enableRetinaScaling: false //레티나 비활성화
        })
        fbCanvas.viewportTransform = fabric.util.composeMatrix({ translateX: 256, translateY: 256 })

        document.addEventListener('keydown', (evt) => {
            console.log(evt)
            switch (evt.key) {
                case 'q': //정점 정보 리스팅
                    console.log(polygon.points)
                    break;
            }
        })

        var points = [{
            x: -64, y: 0
        }, {
            x: 0, y: -64
        },
        {
            x: 64, y: 0
        }]

        var polygon = new fabric.Polygon(points, {
            left: 0,
            top: 0,
            fill: 'transparent',
            strokeWidth: 2,
            stroke: '#ffff00',
            //scaleX: 4,
            //scaleY: 4,
            objectCaching: false,
            transparentCorners: false,
            cornerColor: 'blue',
        });
        fbCanvas.add(polygon)

        var polygon2 = new fabric.Polygon(points, {
            left: 64,
            top: 32,
            fill: 'transparent',
            strokeWidth: 2,
            stroke: '#ffff00',
            //scaleX: 4,
            //scaleY: 4,
            objectCaching: false,
            transparentCorners: false,
            cornerColor: 'blue',
        });
        fbCanvas.add(polygon2)

        {
            fbCanvas.add(new fabric.Line([-256, 0, 256, 0], {
                //fill: 'red',
                stroke: '#0f0',
                strokeWidth: 2,
                selectable: false,
                evented: false,
            }));
            fbCanvas.add(new fabric.Line([0, -256, 0, 256], {
                //fill: 'red',
                stroke: '#0f0',
                strokeWidth: 2,
                selectable: false,
                evented: false,
            }))
        }

        //절대 좌표 구하기 
        function convertAbsolutePoint(area) {
            return area.points
                .map(p => fabric.util.transformPoint({ x: p.x - area.pathOffset.x, y: p.y - area.pathOffset.y }, area.calcTransformMatrix()));
        }

        function updateIntersect() {

            circles.forEach(_ => {
                fbCanvas.remove(_)
            })
            circles = []

            //교차점 구하기 
            var intersect = fabric.Intersection.intersectPolygonPolygon(convertAbsolutePoint(polygon), convertAbsolutePoint(polygon2));
            if (intersect.status === "Intersection") {
                intersect.points.forEach(pt => {
                    let _tr = fabric.util.composeMatrix({ translateX: pt.x, translateY: pt.y })
                    let circle = new fabric.Circle({
                        radius: 8, fill: 'red'
                    });
                    fabric.util.applyTransformToObject(circle, _tr)
                    circle.setCoords()
                    fbCanvas.add(circle)
                    circles.push(circle)
                })
            }
        }
        let circles = []
        polygon.on('moving', updateIntersect)
        polygon.on('rotating', updateIntersect)

        console.log(fbCanvas.getObjects())

    </script>




</body>

</html>